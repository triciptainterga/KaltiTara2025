var idWA = "3";
var noWA = "08170154444";
var apiKeyWA = "qRbkioekrn2xVSUwQWWiBzet03ysIhhUZZD";
var urlDatakelola;
var companyToken;
$(document).ready(function () {
    urlDatakelola = $("#SM_UrlDatakelola").val();
    companyToken = $("#SM_CompanyToken").val();
    MasterCombo();
    LoadingUser()
    $("#TxtSearchingUserName").on("input", function () {
        var jumlahString = $(this).val().length;
        if (jumlahString >= 3) {
            SearchingUser($(this).val());
        } else if (jumlahString == 0) {
            SearchingUser($(this).val(""));
        }
    });
    $('#Agent_Checkbox').click(function () {
        if ($(this).is(':checked')) {
            $("#ContentPlaceHolder1_HDUserAgent_Checkbox").val("1")
        } else {
            $("#ContentPlaceHolder1_HDUserAgent_Checkbox").val("0")
        }
    });
    loadSiteDataCards();
});
function loadSiteDataCards() {
    const siteDiv = $("#divCardSite");
    const allSites = ["Pusat", "Tanjung Priok", "Pasar Baru", "Soekarno Hatta"];

    $.ajax({
        type: "POST",
        url: "asmx/Crm_Trx_Agent_SM.asmx/UIDESK_TrmMasterCombo",
        data: JSON.stringify({
            TrxID: "Multichat",
            TrxUserName: $("#hd_sessionLogin").val(),
            TrxAction: "UIDESK51"
        }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (response) {
            const siteData = response?.d ? JSON.parse(response.d) : [];
            const siteCounts = {};

            // Count users per site
            siteData.forEach((user) => {
                const siteName = user.Site || "Pusat";
                siteCounts[siteName] = (siteCounts[siteName] || 0) + 1;
            });

            siteDiv.empty(); // Clear previous cards
            $("#divUserNotification").empty(); // Clear user notifications

            // Generate site cards
            allSites.forEach((siteName) => {
                const siteAgentCount = siteCounts[siteName] || 0;
                const bgClass = {
                    "Pusat": "bg-primary",
                    "Tanjung Priok": "bg-danger",
                    "Pasar Baru": "bg-success",
                    "Soekarno Hatta": "bg-warning"
                }[siteName] || "bg-light";

                const siteCardHtml = `
                    <div class="card box box-link-shadow text-left card-site ${bgClass}" 
                         data-site="${siteName}" 
                         style="cursor:pointer; padding: 10px; margin: 0 7.5px; flex: 1 1 calc(50% - 15px); max-width: calc(50% - 15px);">
                        <div class="card-body text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1 text-start">
                                    <p class="mb-1 text-truncate text-white" style="font-size: 22px;">${siteName}</p>
                                </div>
                                <div class="text-end">
                                    <h5 class="mb-0 text-white" style="font-size: 20px;">${siteAgentCount}</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                siteDiv.append(siteCardHtml);
            });

            // Bind click event
            $(".card-site").off("click").on("click", function () {
                $(".card-site").removeClass("active");
                $(this).addClass("active");
                const selectedSite = $(this).data("site");
                LoadingUser(selectedSite);
            });
        },
        error: function (xhr) {
            console.error("Error loading site data:", xhr.responseText);
            alert("Failed to load data. Please try again.");
        }
    });
}

function LoadingUser(selectedSite) {
    $.ajax({
        type: "POST",
        url: "asmx/Crm_Trx_Agent_SM.asmx/UIDESK_TrmMasterCombo",
        data: JSON.stringify({
            TrxID: "Multichat",
            TrxUserName: $("#hd_sessionLogin").val(),
            TrxAction: "UIDESK51"
        }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (response) {
            const json = response?.d ? JSON.parse(response.d) : [];
            const filteredUsers = json.filter(user => user.Site === selectedSite);

            $('#divUserNotification').empty(); // Clear existing content

            if (filteredUsers.length > 0) {
                filteredUsers.forEach(user => {
                    const scheduleStateColor = user.ScheduleState === "1" ? "success" : "danger";

                    const userNotificationHtml = `
                        <div class="col-xl-3 col-sm-6">
                            <div class="card border shadow-none">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-shrink-0 avatar rounded-circle me-3">
                                            <img src="assets/images/users/user.png" alt="User" class="img-fluid rounded-circle">
                                        </div>
                                        <div class="flex-grow-1 overflow-hidden">
                                            <h5 class="font-size-15 mb-1 text-truncate">
                                                <a href="#" class="text-dark">${user.NAME} ${user.Alias ? ` (${user.Alias})` : ""}</a>
                                            </h5>
                                            <p class="text-muted text-truncate mb-0">
                                                <span class="text-dark">${user.product_campaign}</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent border-top d-flex">
                                    <div class="flex-grow-1">
                                        <span class="badge rounded-pill" style="background-color: #51d28c; color: white; font-size: 14px; cursor: pointer;" onclick="ReleaseSchedule('${user.id}')">
                                            ${user.maxhandle}
                                        </span>
<<<<<<< HEAD
                                        <!-- MaxHandleDK badge -->
                                        <span class="badge rounded-pill" style="background-color: #038edc; color: white; font-size: 14px; cursor: pointer;" onclick="ReleaseScheduleDK('${user.agent_name}')">
=======
                                        <span class="badge rounded-pill ms-2" style="background-color: #038edc; color: white; font-size: 14px; cursor: pointer;" onclick="ReleaseScheduleDK('${user.id}')">
>>>>>>> 4bb401a7f6bd06bf80cf63b5e3c3fcab6c0e6c38
                                            ${user.MaxHandleDK}
                                        </span>
                                    </div>
                                    <div class="flex-shrink-0 ms-2">
                                        <span class="badge rounded-pill badge-soft-primary font-size-12">${user.Site}</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    $('#divUserNotification').append(userNotificationHtml);
                });
            } else {
                $('#divUserNotification').append(' ');
            }
        },
        error: function (xhr) {
            console.error("Error loading user data:", xhr.responseText);
            alert("Failed to load user data. Please try again.");
        }
    });
}

function SearchingUser(ParameterID) {
    const KondisiData = ParameterID === "" ? "0" : ParameterID;

    $.ajax({
        type: "POST",
        url: "asmx/Crm_Trx_Agent_SM.asmx/BRA_SearchingDigitalChannelAgent",
        data: JSON.stringify({
            Type: 'Multichat',
            Value: KondisiData,
            UserName: $("#hd_sessionLogin").val()
        }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {
            const json = JSON.parse(data.d);
            $('#divUserNotification').empty();

            if (json.length > 0) {
                json.forEach(user => {
                    const scheduleStateColor = user.ScheduleState === "1" ? "success" : "danger";

                    const resultUserNotification = `
                        <div class="col-xl-3 col-sm-6">
                            <div class="card border shadow-none">
                                <div class="card-body p-4">
                                    <div class="d-flex align-items-start">
                                        <div class="flex-shrink-0 avatar rounded-circle me-3">
                                            <img src="assets/images/users/user.png" alt="" class="img-fluid rounded-circle">
                                        </div>
                                        <div class="flex-grow-1 overflow-hidden">
                                            <h5 class="font-size-15 mb-1 text-truncate">
                                                <a href="#" class="text-dark">${user.NAME}</a>
                                            </h5>
                                            <p class="text-muted text-truncate mb-0">
                                                <span class="text-dark">${user.product_campaign}</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer bg-transparent border-top d-flex justify-content-between align-items-center">
                                    <div class="badge-wrapper">
                                        <span class="badge rounded-pill" style="background-color: #51d28c; color: white; font-size: 14px; cursor: pointer;" onclick="ReleaseSchedule('${user.id}')">${user.maxhandle}</span>
                                        <span class="badge rounded-pill ms-2" style="background-color: #038edc; color: white; font-size: 14px; cursor: pointer;" onclick="ReleaseScheduleDK('${user.id}')">${user.MaxHandleDK}</span>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <span class="badge rounded-pill badge-soft-primary font-size-12">${user.Site}</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    $('#divUserNotification').append(resultUserNotification);
                });
            } else {
                $('#divUserNotification').append('<p class="text-center">No users found.</p>');
            }

            // Remove POST status from history
            history.replaceState(null, '', location.href);
        },
        error: function (xhr) {
            console.error("Error searching user data:", xhr.responseText);
            // alert("Failed to search user data. Please try again.");
        }
    });
}


function DataTableAgent(TrxValue) {
    var myTable = $('#TrxAgent').DataTable();
    $.ajax({
        type: "POST",
        url: "asmx/Crm_Trx_Agent_SM.asmx/UIDESK_TrmMasterCombo",
        data: "{TrxID:'0', TrxUserName: '" + $("#hd_sessionLogin").val() + "', TrxAction: 'UIDESK31'}",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {

            var json = JSON.parse(data.d);
            var i, x, result = "";

            myTable.clear().draw();
            for (i = 0; i < json.length; i++) {

                var TrxParam = '<input type = "checkbox" class="checkbox" name="checkbox' + json[i].USERID + '" id = "checkbox' + json[i].USERID + '" >' +
                    '<label class="checkbox" for="checkbox' + json[i].USERID + '"></label>'
                myTable.row.add([TrxParam, json[i].USERID, json[i].USERNAME, json[i].NAME, json[i].EMAIL_ADDRESS, json[i].TokenMeta]).draw(false);

            }

        },
        error: function (xmlHttpRequest, textStatus, errorThrown) {
            console.log(xmlHttpRequest.responseText);
            console.log(textStatus);
            console.log(errorThrown);
        }
    })
}
function NewData() {
    $("#modal-agent").modal('show');
    $("#Simpan").show();
    $("#Update").hide();
    $("#Delete").hide();
}
function EditUser(ParamID) {
    $("#ContentPlaceHolder1_TrxTransaksiID").val(ParamID);
    $("#addContactModal").modal('show');
    SelectDetailProduct();
}
function DeleteUser(ParamID, ChannelID) {
    $("#ContentPlaceHolder1_TrxTransaksiID").val(ParamID)
    SelectDetailProduct()
    if ($("#ContentPlaceHolder1_TrxTransaksiID").val() == "") {
        swal(
            '',
            'Data is empty',
            'info'
        ).then(function () {
            return false;
        });
        return false;
    }
    swal({
        title: "Do you want to process?",
        icon: "warning",
        buttons: true,
        dangerMode: true,
    })
        .then((willDelete) => {
            if (willDelete) {

                if (ChannelID == "5" || ChannelID == "4") {
                    strType = "Page";
                } else if (ChannelID == "9") {
                    strType = "Account";
                } else if (ChannelID == "18") {
                    strType = "Page";
                } else if (ChannelID == "11") {
                    strType = "Page";
                } else {
                    strType = "Account";
                }
                var settings = {
                    "url": urlDatakelola + "api/agent/unassign-multiple",
                    "method": "POST",
                    "timeout": 0,
                    "headers": {
                        "Accept": "/",
                        "User-Agent": "Thunder Client (https://www.thunderclient.com)",
                        "Content-Type": "application/json"
                    },
                    "data": JSON.stringify({
                        "token": companyToken,
                        "account_id": $("#ContentPlaceHolder1_TrxAccountID").val(),
                        "type": strType,
                        "agent_tokens": [$('#ContentPlaceHolder1_TrxTokenMetaAgent').val()]
                    }),
                };

                $.ajax(settings).done(function (response) {
                    console.log(response);

                    if (response.success == true) {

                        var form_data = JSON.stringify({ TrxID: $("#ContentPlaceHolder1_TrxTransaksiID").val(), TrxUserName: $("#hd_sessionLogin").val() });
                        $.ajax({
                            url: "asmx/Crm_Trx_Agent_SM.asmx/DeleteAgentDistributionData",
                            method: "POST",
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            data: form_data,
                            success: function (data) {
                                console.log(form_data)

                                var json = JSON.parse(data.d);
                                var i = "";
                                for (i = 0; i < json.length; i++) {
                                    if (json[i].Result == "True") {
                                        swal(
                                            '',
                                            'Delete Data Has Been Success',
                                            'success'
                                        ).then(function () {
                                            window.location = "Crm_Trx_Multichat.aspx?";
                                        });
                                    } else {
                                        swal(
                                            '',
                                            'Delete Data Has Been Failed !',
                                            'error'
                                        ).then(function () {
                                            window.location = "Crm_Trx_Multichat.aspx?";
                                        });
                                        return false;
                                    }
                                }

                            },
                            error: function (xmlHttpRequest, textStatus, errorThrown) {
                                console.log(xmlHttpRequest.responseText);
                                console.log(textStatus);
                                console.log(errorThrown);
                            },
                            complete: function () {

                            }
                        });

                    }


                });

            }
        });
}
function MasterCombo() {
    var ComboSosialMedia = $('#ComboSosialMedia');
    $.ajax({
        type: "POST",
        url: "asmx/Crm_Trx_Agent_SM.asmx/UIDESK_TrmMasterCombo",
        data: "{TrxID:'0', TrxUserName: '" + $("#hd_sessionLogin").val() + "', TrxAction: 'UIDESK145'}",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {

            var json = JSON.parse(data.d);
            var i, x, ResultSosialMedia = "";

            for (i = 0; i < json.length; i++) {

                ResultSosialMedia = '<option value="' + json[i].TypeID + '">' + json[i].Name + '</option>';
                ComboSosialMedia.append(ResultSosialMedia);

            }

        },
        error: function (xmlHttpRequest, textStatus, errorThrown) {
            console.log(xmlHttpRequest.responseText);
            console.log(textStatus);
            console.log(errorThrown);
        }
    })

    var ComboHandle = $('#ComboHandle');
    var ComboCmbHandling = $('#CmbHandling');
    $.ajax({
        type: "POST",
        url: "asmx/Crm_Trx_Agent_SM.asmx/UIDESK_TrmMasterCombo",
        data: "{TrxID:'0', TrxUserName: '" + $("#hd_sessionLogin").val() + "', TrxAction: 'UIDESK25'}",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {

            var json = JSON.parse(data.d);
            var i, x, result = "";
            for (i = 0; i < json.length; i++) {

                result = '<option value="' + json[i].max_handle + '">' + json[i].max_handle + '</option>';
                ComboHandle.append(result);
                ComboCmbHandling.append(result);
                

            }

        },
        error: function (xmlHttpRequest, textStatus, errorThrown) {
            console.log(xmlHttpRequest.responseText);
            console.log(textStatus);
            console.log(errorThrown);
        }
    })
}
function CmbSosialMediaAccount(TrxValue) {
    //Facebook 5 -> Page
    //Instagram 9 -> Account
    console.log("Get Data Multichat List FB/IG" + TrxValue);
    //https://multichat-2.uidesk.id/api/chat/lists?token=01H8X14ZNY1CQAAQ7ZF51J17Z9
    var settings = {
        "url": urlDatakelola + "api/channel/accounts?token=" + $("#SM_CompanyToken").val() + "",
        "method": "GET",
        "timeout": 0,
    };
    var CmbSosialMediaTransaksi = $('#ComboAccount');
    $.ajax(settings).done(function (response) {

        console.log(response);
        var json = response.data;
        var i, x, result = "";

        CmbSosialMediaTransaksi.empty();
        for (i = 0; i < json.length; i++) {
            if (TrxValue == "5" && json[i].channel_id == "1") {
                result = '<option value="' + json[i].account_id + '">' + json[i].name + '</option>';
                CmbSosialMediaTransaksi.append(result);
            } else if (TrxValue == "9" && json[i].channel_id == "2") {
                result = '<option value="' + json[i].account_id + '">' + json[i].name + '</option>';
                CmbSosialMediaTransaksi.append(result);
            } else if (TrxValue == "4" && json[i].channel_id == "8") {
                result = '<option value="' + json[i].account_id + '">' + json[i].name + '</option>';
                CmbSosialMediaTransaksi.append(result);
            } else if (TrxValue == "5" && json[i].channel_id == "5") {
                result = '<option value="' + json[i].account_id + '">' + json[i].name + '</option>';
                CmbSosialMediaTransaksi.append(result);
            } else if (TrxValue == "14" && json[i].channel_id == "14") {
                result = '<option value="' + json[i].account_id + '">' + json[i].name + '</option>';
                CmbSosialMediaTransaksi.append(result);
            } else if (TrxValue == "15" && json[i].channel_id == "15") {
                result = '<option value="' + json[i].account_id + '">' + json[i].name + '</option>';
                CmbSosialMediaTransaksi.append(result);
            } else if (TrxValue == "16" && json[i].channel_id == "16") {
                result = '<option value="' + json[i].account_id + '">' + json[i].name + '</option>';
                CmbSosialMediaTransaksi.append(result);
            } else if (TrxValue == "18" && json[i].channel_id == "3") {
                result = '<option value="' + json[i].account_id + '">' + json[i].name + '</option>';
                CmbSosialMediaTransaksi.append(result);
            } else if (TrxValue == "11" && json[i].channel_id == "7") {
                result = '<option value="' + json[i].account_id + '">' + json[i].name + '</option>';
                CmbSosialMediaTransaksi.append(result);
            }
        }
    });
}
function Add_DropdownSosialMedia(smID) {
    var TrxText = $("#ComboSosialMedia").find("option:selected").text();
    var TrxValue = $("#ComboSosialMedia").val();
    CmbSosialMediaAccount(TrxValue);
    DataTableAgent(TrxValue);
}
function Add_DropdownAccountSM(smID) {
    var TrxText = $("#ComboAccount").find("option:selected").text();
    var TrxValue = $("#ComboAccount").val();
}
function encodeData(s) {
    return encodeURIComponent(s).replace(/\-/g, "%2D").replace(/\_/g, "%5F").replace(/\./g, "%2E").replace(/\!/g, "%21").replace(/\~/g, "%7E").replace(/\*/g, "%2A").replace(/\'/g, "%27").replace(/\(/g, "%28").replace(/\)/g, "%29");
}
$(function () {
    //Assign Click event to Button.
    $("#btnSimpan").click(function () {
        //var message = "Id Name                  Country\n";
        var message = ""
        var varToken = [];
        //Loop through all checked CheckBoxes in GridView.
        $("#TrxAgent input[type=checkbox]:checked").each(function () {
            var row = $(this).closest("tr")[0];
            message += row.cells[1].innerHTML + ",";
            varToken.push(row.cells[5].innerHTML);
            //message += "   " + row.cells[2].innerHTML;
            //message += "   " + row.cells[3].innerHTML;
            //message += "\n";
        });
        console.log("token ", varToken)
        //Display selected Row data in Alert Box.
        //alert(message);
        //return false;
        $("#ContentPlaceHolder1_TrxUserAgentId").val(message)

        if ($("#ComboSosialMedia").val() == "Select" || $("#ComboSosialMedia").val() == "") {
            swal(
                '',
                'Sosial Media Type is empty',
                'info'
            ).then(function () {
                return false;
            });
            return false;
        }
        if ($("#ComboAccount").val() == "Select" || $("#ComboAccount").val() == "") {
            swal(
                '',
                'Sosial Media Account is empty',
                'info'
            ).then(function () {
                return false;
            });
            return false;
        }
        if ($("#ComboHandle").val() == "Select" || $("#ComboHandle").val() == "") {
            swal(
                '',
                'Maximal Handle Data is empty',
                'info'
            ).then(function () {
                return false;
            });
            return false;
        }
        if ($("#ContentPlaceHolder1_TrxUserAgentId").val() == "") {
            swal(
                '',
                'Agent is empty',
                'info'
            ).then(function () {
                return false;
            });
            return false;
        }
        var strType = "";
        swal({
            title: "Do you want to process?",
            icon: "warning",
            buttons: true,
            dangerMode: true,
        })
            .then((willDelete) => {
                if (willDelete) {
                    //Post Data To Multichat
                    //Facebook 5,WA 4 -> Page
                    //Instagram 9 -> Account
                    if ($("#ComboSosialMedia").val() == "5" || $("#ComboSosialMedia").val() == "4") {
                        strType = "Page";
                    } else if ($("#ComboSosialMedia").val() == "9") {
                        strType = "Account";
                    } else if ($("#ComboSosialMedia").val() == "18") {
                        strType = "Page";
                    } else if ($("#ComboSosialMedia").val() == "11") {
                        strType = "Page";
                    } else {
                        strType = "Account";
                    }
                    var settings = {
                        "url": urlDatakelola + "api/agent/assign-multiple",
                        "method": "POST",
                        "timeout": 0,
                        "headers": {
                            "Accept": "/",
                            "User-Agent": "Thunder Client (https://www.thunderclient.com)",
                            "Content-Type": "application/json"
                        },
                        "data": JSON.stringify({
                            "token": companyToken,
                            "account_id": $("#ComboAccount").val(),
                            "type": strType,
                            "agent_tokens": varToken
                        }),
                    };

                    $.ajax(settings).done(function (response) {
                        console.log(response);

                        if (response.success == true) {

                            var form_data = JSON.stringify({
                                TrxUserName: $("#hd_sessionLogin").val(), TrxData: $("#ContentPlaceHolder1_TrxUserAgentId").val(),
                                TrxSosialMedia: $("#ComboSosialMedia").val(), TrxCampaign: $("#ComboAccount").val(), TrxAccountName: $("#ComboAccount option:selected").text(),
                                MaxCampaign: $("#ComboHandle").val(), sm_type: "0"
                            });
                            $.ajax({
                                url: "asmx/Crm_Trx_Agent_SM.asmx/InsertAgentDistributionData",
                                method: "POST",
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                data: form_data,
                                success: function (data) {
                                    console.log(form_data)

                                    var json = JSON.parse(data.d);
                                    var i = "";
                                    for (i = 0; i < json.length; i++) {
                                        if (json[i].Result == "True") {
                                            swal(
                                                '',
                                                'Insert Data Has Been Success ',
                                                'success'
                                            ).then(function () {
                                                window.location.href = "Crm_Trx_Multichat.aspx?";
                                            });
                                        } else {
                                            swal(
                                                '',
                                                'Insert Data Has Been Failed !',
                                                'error'
                                            ).then(function () {
                                                window.location = "Crm_Trx_Multichat.aspx?";
                                            });
                                            return false;
                                        }
                                    }

                                },
                                error: function (xmlHttpRequest, textStatus, errorThrown) {
                                    console.log(xmlHttpRequest.responseText);
                                    console.log(textStatus);
                                    console.log(errorThrown);
                                },
                                complete: function () {

                                }
                            });

                            var settings = {
                                "url": "https://dk.beacukai.go.id/api/agent/max_handle",
                                "method": "POST",
                                "timeout": 0,
                                "headers": {
                                    "Content-Type": "application/x-www-form-urlencoded",
                                    "Authorization": "Bearer " + companyToken + "",
                                    "Cookie": "cookiesession1=678B2924C4A68D40F5CE4B3B62DE25C6; cookiesession1=678B2924A848D084E27047F1128F6DD8; cookiesession1=678B292491F6FC9402082E042F27CFC8"
                                },
                                "data": {
                                    "token_agent": varToken,
                                    "max_handle": $("#ComboHandle").val()
                                }
                            };

                            $.ajax(settings).done(function (response) {
                                console.log(response);
                            });


                        }


                    });


                }

            });

    });
});
function ActionUpdate() {
    if ($("#ContentPlaceHolder1_TrxTransaksiID").val() == "") {
        swal(
            '',
            'Agent is empty',
            'info'
        ).then(function () {
            return false;
        });
        return false;
    }
    var TrxFlag = $("#ContentPlaceHolder1_HDUserAgent_Checkbox").val();
    swal({
        title: "Do you want to process?",
        icon: "warning",
        buttons: true,
        dangerMode: true,
    })
        .then((willDelete) => {
            if (willDelete) {

                var form_data = JSON.stringify({ TrxID: $("#ContentPlaceHolder1_TrxTransaksiID").val(), TrxUserName: $("#hd_sessionLogin").val(), TrxSosialMedia: $("#CmbUpdateSosialMediaType").val(), TrxAccount: $("#CmbUpdateSosialMediaAccount").val(), TrxData: $("#CmbUpdateMaxCampaign").val(), TrxFlag: TrxFlag });
                $.ajax({
                    url: "asmx/TrxAgentSM.asmx/UpdateAgentDistributionData",
                    method: "POST",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: form_data,
                    success: function (data) {
                        console.log(form_data)

                        var json = JSON.parse(data.d);
                        var i = "";
                        for (i = 0; i < json.length; i++) {
                            if (json[i].Result == "True") {
                                swal(
                                    '',
                                    'Update Data Has Been Success',
                                    'success'
                                ).then(function () {
                                    $("#CmbUpdateSosialMedia").val("");
                                    $("#CmbUpdateMaxCampaign").val("")
                                    $("#ContentPlaceHolder1_HDUserAgent_Checkbox").val("")
                                    $("#modalright").modal('hide');
                                    window.location.href = "Crm_Trx_Agent_SM.aspx";
                                });
                            } else {
                                swal(
                                    '',
                                    'Update Data Has Been Failed !',
                                    'error'
                                ).then(function () {
                                    window.location = "Crm_Trx_Agent_SM.aspx";
                                });
                                return false;
                            }
                        }

                    },
                    error: function (xmlHttpRequest, textStatus, errorThrown) {
                        console.log(xmlHttpRequest.responseText);
                        console.log(textStatus);
                        console.log(errorThrown);
                    },
                    complete: function () {

                    }
                });

            }
        });
}
function ActionUpdateDK() {
    if ($("#ContentPlaceHolder1_TrxTransaksiID_DK").val() == "") {
        swal(
            '',
            'Agent is empty',
            'info'
        ).then(function () {
            return false;
        });
        return false;
    }
    var TrxFlag = $("#ContentPlaceHolder1_HDUserAgent_Checkbox").val();
    swal({
        title: "Do you want to process?",
        icon: "warning",
        buttons: true,
        dangerMode: true,
    })
    .then((willDelete) => {
        if (willDelete) {
            var form_data = JSON.stringify({
                TrxID: $("#ContentPlaceHolder1_TrxTransaksiID_DK").val(),
                TrxUserName: $("#hd_sessionLogin").val(),
                TrxSosialMedia: $("#CmbUpdateSosialMediaType").val(),
                TrxAccount: $("#CmbUpdateSosialMediaAccount").val(),
                TrxData: $("#CmbUpdateMaxCampaign").val(),
                TrxFlag: TrxFlag
            });
            $.ajax({
                url: "asmx/TrxAgentSM.asmx/UpdateAgentDistributionData",
                method: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: form_data,
                success: function (data) {
                    var json = JSON.parse(data.d);
                    for (var i = 0; i < json.length; i++) {
                        if (json[i].Result == "True") {
                            swal(
                                '',
                                'Update Data Has Been Success',
                                'success'
                            ).then(function () {
                                $("#CmbUpdateSosialMedia").val("");
                                $("#CmbUpdateMaxCampaign").val("");
                                $("#ContentPlaceHolder1_HDUserAgent_Checkbox").val("");
                                $("#modalright").modal('hide');
                                window.location.href = "Crm_Trx_Agent_SM.aspx";
                            });
                        } else {
                            swal(
                                '',
                                'Update Data Has Been Failed!',
                                'error'
                            ).then(function () {
                                window.location = "Crm_Trx_Agent_SM.aspx";
                            });
                            return false;
                        }
                    }
                },
                error: function (xhr, status, error) {
                    console.log(xhr.responseText);
                    console.log(status);
                    console.log(error);
                    swal('Error', 'Failed to update data. Please try again.', 'error');
                }
            });
        }
    });
}
function SelectDetailProduct() {
    $.ajax({
        type: "POST",
        url: "asmx/Crm_Trx_Agent_SM.asmx/UIDESK_TrmMasterCombo",
        data: "{TrxID:'" + $("#ContentPlaceHolder1_TrxTransaksiID").val() + "', TrxUserName: '" + $("#hd_sessionLogin").val() + "', TrxAction: 'UIDESK27'}",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {

            var json = JSON.parse(data.d);
            var i, x, result = "";

            for (i = 0; i < json.length; i++) {

                $('#CmbUpdateSosialMediaType').val(json[i].channelid);
                $('#ContentPlaceHolder1_TrxAccountID').val(json[i].product_id);
                //$('#ComboUpdateHandle').val(json[i].maxhandle);
                $('#ContentPlaceHolder1_TrxTokenMetaAgent').val(json[i].TokenMeta);

            }

        },
        error: function (xmlHttpRequest, textStatus, errorThrown) {
            console.log(xmlHttpRequest.responseText);
            console.log(textStatus);
            console.log(errorThrown);
        }
    })
}
function SelectDetailProductDK() {
    $.ajax({
        type: "POST",
        url: "asmx/Crm_Trx_Agent_SM.asmx/UIDESK_TrmMasterCombo",
        data: "{TrxID:'" + $("#ContentPlaceHolder1_TrxTransaksiID_DK").val() + "', TrxUserName: '" + $("#hd_sessionLogin").val() + "', TrxAction: 'UIDESK27'}",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {
            var json = JSON.parse(data.d);
            if (json.length > 0) {
                $('#CmbUpdateSosialMediaType').val(json[0].channelid);
                $('#ContentPlaceHolder1_TrxAccountID').val(json[0].product_id);
                $('#ContentPlaceHolder1_TrxTokenMetaAgent').val(json[0].TokenMeta);
            }
        },
        error: function (xhr, status, error) {
            console.log(xhr.responseText);
            console.log(status);
            console.log(error);
            swal('Error', 'Failed to load product details. Please try again.', 'error');
        }
    });
}
function CmbUpdateSosialMediaType(TrxChannelID) {
    $('#CmbUpdateSosialMediaType').attr("disabled", true);
    var CmbUpdateSosialMediaType = $('#CmbUpdateSosialMediaType');
    $.ajax({
        type: "POST",
        url: "asmx/Crm_Trx_Agent_SM.asmx/UIDESK_TrmMasterCombo",
        data: "{TrxID:'" + TrxChannelID + "', TrxUserName: '" + $("#hd_sessionLogin").val() + "', TrxAction: 'UIDESK32'}",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {

            var json = JSON.parse(data.d);
            var i, x, result = "";

            CmbUpdateSosialMediaType.empty();
            for (i = 0; i < json.length; i++) {

                result = '<option value="' + json[i].TypeID + '">' + json[i].Name + '</option>';
                CmbUpdateSosialMediaType.append(result);

            }

        },
        error: function (xmlHttpRequest, textStatus, errorThrown) {
            console.log(xmlHttpRequest.responseText);
            console.log(textStatus);
            console.log(errorThrown);
        }
    })
}
function CmbUpdateSosialMediaAccount(TrxProductID) {
    $('#CmbUpdateSosialMediaAccount').attr("disabled", true);
    var CmbUpdateSosialMediaAccount = $('#CmbUpdateSosialMediaAccount');
    $.ajax({
        type: "POST",
        url: "asmx/Crm_Trx_Agent_SM.asmx/UIDESK_TrmMasterCombo",
        data: "{TrxID:'" + TrxProductID + "', TrxUserName: '" + $("#hd_sessionLogin").val() + "', TrxAction: 'UIDESK144'}",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {

            var json = JSON.parse(data.d);
            var i, x, result = "";

            CmbUpdateSosialMediaAccount.empty();
            for (i = 0; i < json.length; i++) {

                result = '<option value="' + json[i].product_id + '">' + json[i].product_campaign + '</option>';
                CmbUpdateSosialMediaAccount.append(result);

            }

        },
        error: function (xmlHttpRequest, textStatus, errorThrown) {
            console.log(xmlHttpRequest.responseText);
            console.log(textStatus);
            console.log(errorThrown);
        }
    })
}
function ReleaseSchedule(ParamID) {
    $("#ContentPlaceHolder1_TrxID").val(ParamID);
    $("#ContentPlaceHolder1_TrxTransaksiID").val(ParamID);
    $("#modal-release-omni").modal('show'); // Memanggil modal Omni
    SelectDetailProduct();
}
function ActionReleaseSchedule() {
    swal({
        title: "Do you want to process?",
        icon: "warning",
        buttons: true,
        dangerMode: true,
    })
        .then((willDelete) => {
            if (willDelete) {

                var settings = {
                    "url": "https://dk.beacukai.go.id/api/agent/max_handle",
                    "method": "POST",
                    "timeout": 0,
                    "headers": {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "Authorization": "Bearer " + companyToken + "",
                        "Cookie": "cookiesession1=678B2924C4A68D40F5CE4B3B62DE25C6; cookiesession1=678B2924A848D084E27047F1128F6DD8; cookiesession1=678B292491F6FC9402082E042F27CFC8"
                    },
                    "data": {
                        "token_agent": $('#ContentPlaceHolder1_TrxTokenMetaAgent').val(),
                        "max_handle": $("#CmbHandling").val()
                    }
                };

                $.ajax(settings).done(function (response) {
                    console.log(response);

                    if (response.success == true) {
                        var form_data = JSON.stringify({
                            ID: $("#ContentPlaceHolder1_TrxID").val(), TrxUserName: $("#hd_sessionLogin").val(), Value: $("#CmbHandling").val(),
                        });
                        $.ajax({
                            url: "asmx/Crm_Trx_Agent_SM.asmx/AssignMaxHandle",
                            method: "POST",
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            data: form_data,
                            success: function (data) {
                                console.log(form_data)

                                var json = JSON.parse(data.d);
                                var i = "";
                                for (i = 0; i < json.length; i++) {
                                    if (json[i].Result == "True") {
                                        swal(
                                            '',
                                            'Insert Data Has Been Success',
                                            'success'
                                        ).then(function () {
                                            window.location.href = "Crm_Trx_Multichat_MC.aspx?";
                                        });
                                    } else {
                                        swal(
                                            '',
                                            'Insert Data Has Been Failed !',
                                            'error'
                                        ).then(function () {
                                            return false;
                                        });
                                        return false;
                                    }
                                }

                            },
                            error: function (xmlHttpRequest, textStatus, errorThrown) {
                                console.log(xmlHttpRequest.responseText);
                                console.log(textStatus);
                                console.log(errorThrown);
                            },
                            complete: function () {

                            }
                        });
                    }

                });

            }
        });
}

function ReleaseScheduleDK(ParamID) {
    $("#ContentPlaceHolder1_TrxID_DK").val(ParamID);
    $("#ContentPlaceHolder1_TrxTransaksiID_DK").val(ParamID);
    $("#modal-release-dk").modal('show'); // Show DK modal
    SelectDetailProductDK();
}

function ActionReleaseScheduleDK() {
    swal({
        title: "Do you want to process?",
        icon: "warning",
        buttons: true,
        dangerMode: true,
    })
    .then((willDelete) => {
        if (willDelete) {
            var form_data = JSON.stringify({
                UserName: $("#ContentPlaceHolder1_TrxID_DK").val(),
                MaxHandle: $("#ComboReleaseDK").val(),
            });

            $.ajax({
                url: "asmx/Crm_Trx_Agent_SM.asmx/BRA_DK_UpdateMaxHandle",
                method: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: form_data,
                success: function (data) {
                    var json = JSON.parse(data.d);
                    for (var i = 0; i < json.length; i++) {
                        if (json[i].Result == "True") {
                            swal(
                                '',
                                'Insert Data Has Been Success',
                                'success'
                            ).then(function () {
                                window.location.href = "Crm_Trx_Multichat_MC.aspx?";
                            });
                        } else {
                            swal(
                                '',
                                'Insert Data Has Been Failed!',
                                'error'
                            );
                            return false;
                        }
                    }
                },
                error: function (xhr, status, error) {
                    console.log(xhr.responseText);
                    console.log(status);
                    console.log(error);
                    swal('Error', 'Failed to update max handle. Please try again.', 'error');
                }
            });
        }
    });
}
